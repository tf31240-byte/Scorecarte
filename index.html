<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ScoreMaster v3.7</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    --primary:#007AFF; --bg:#F2F2F7; --card:#FFF; --text:#1C1C1E;
    --border:#D1D1D6; --btn-bg:#FFF; --btn-active:#E5E5EA;
    --danger:#FF3B30; --success:#34C759; --dealer-color:#FF9500;
}
@media (prefers-color-scheme: dark) {
    :root {
        --primary:#0A84FF; --bg:#000; --card:#1C1C1E; --text:#F2F2F7;
        --border:#38383A; --btn-bg:#2C2C2E; --btn-active:#3A3A3C;
    }
}
.force-dark {
    --bg:#000; --card:#1C1C1E; --text:#F2F2F7; --border:#38383A;
}

*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif;user-select:none}
body{margin:0;background:var(--bg);color:var(--text);padding-bottom:calc(160px + env(safe-area-inset-bottom))}
.hidden{display:none!important}

.container{max-width:600px;margin:auto;padding:16px}
header{display:flex;justify-content:space-between;align-items:center}
.btn-reset{background:none;border:none;font-size:20px}

.players-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.p-card{background:var(--card);padding:18px;border-radius:20px;text-align:center;border:3px solid transparent}
.p-card.is-dealer{border-color:var(--dealer-color)}
.p-card.is-active{box-shadow:0 0 0 3px var(--primary);transform:scale(1.02)}
.p-name{font-size:14px;font-weight:800;text-transform:uppercase;cursor:pointer}
.p-score{font-size:38px;font-weight:900;transition:transform .2s}
.p-score.bump{transform:scale(1.12)}
.p-temp{animation:tempPulse .3s}

@keyframes tempPulse{
    0%{transform:scale(1);opacity:.6}
    50%{transform:scale(1.15);opacity:1}
}

.chart-box{background:var(--card);border-radius:24px;height:220px;padding:15px;margin-bottom:25px}

.h-row{background:var(--card);padding:12px;border-radius:14px;display:flex;align-items:center;margin-bottom:8px}
.h-idx{width:26px;height:26px;border-radius:50%;background:var(--bg);font-size:11px;display:flex;align-items:center;justify-content:center}
.h-badge{padding:4px 8px;border-radius:8px;color:white;font-weight:700}
.h-badge.win{outline:2px solid white}

.action-bar{
    position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
    width:92%;display:flex;gap:12px;padding-bottom:env(safe-area-inset-bottom)
}
.main-btn{flex:1;padding:18px;border-radius:18px;font-weight:800;border:none}
.btn-validate{background:var(--primary);color:white}
.btn-undo{background:#444;color:white}

.sheet-overlay{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,.6);display:flex;align-items:flex-end;
    opacity:0;pointer-events:none;transition:.3s
}
.sheet-overlay.active{opacity:1;pointer-events:auto}
.sheet-content{
    background:var(--bg);width:100%;max-width:600px;
    border-radius:30px 30px 0 0;padding:20px;
    transform:translateY(100%);transition:.4s cubic-bezier(0,.5,.2,1)
}
.sheet-overlay.active .sheet-content{transform:translateY(0)}

.nb{height:55px;border-radius:15px;font-size:22px;border:none;background:var(--btn-bg)}
.nb:active{background:var(--btn-active)}
</style>
</head>

<body>

<div id="setup" class="container">
<h1 style="text-align:center;margin-top:60px">ScoreMaster v3.7</h1>
<div onclick="app.initGame('belote')" class="p-card">üÉè Belote</div>
<div onclick="app.initGame('standard')" class="p-card">üé≤ Multi joueurs</div>
</div>

<div id="game" class="container hidden">
<header>
<h2 id="game-title">Partie</h2>
<button class="btn-reset" onclick="app.toggleDarkMode()">üåô</button>
</header>

<div class="chart-box"><canvas id="chart"></canvas></div>
<div id="grid" class="players-grid"></div>
<div id="history"></div>
</div>

<div id="dock" class="action-bar hidden">
<button class="main-btn btn-undo" onclick="app.undo()">ANNULER</button>
<button class="main-btn btn-validate" onclick="app.validateRound()">VALIDER</button>
</div>

<div id="sheet" class="sheet-overlay">
<div class="sheet-content">
<div class="numpad">
<button class="nb" onclick="app.typeNum(1)">1</button>
<button class="nb" onclick="app.typeNum(2)">2</button>
<button class="nb" onclick="app.typeNum(3)">3</button>
<button class="nb" onclick="app.typeNum(4)">4</button>
<button class="nb" onclick="app.typeNum(5)">5</button>
<button class="nb" onclick="app.typeNum(6)">6</button>
<button class="nb" onclick="app.typeNum(7)">7</button>
<button class="nb" onclick="app.typeNum(8)">8</button>
<button class="nb" onclick="app.typeNum(9)">9</button>
<button class="nb" onclick="app.toggleNegative()">+/-</button>
<button class="nb" onclick="app.typeNum(0)">0</button>
<button class="nb" onclick="app.backspace()">‚å´</button>
</div>
</div>
</div>

<script>
const APP_VERSION="3.7", STORAGE_KEY="scoremaster";
const COLORS=['#007AFF','#FF2D55','#34C759','#FF9500'];

function haptic(t="light"){
    if(!navigator.vibrate)return;
    navigator.vibrate({light:8,medium:15,heavy:25}[t]||8);
}

const app={
data:{mode:null,players:[],history:[],tempScores:{},dealerId:null},
activePlayerId:null,chart:null,

init(){
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw)return;
    const saved=JSON.parse(raw);
    if(saved.version===APP_VERSION){this.data=saved.data;this.showGame();}
},

save(){
    localStorage.setItem(STORAGE_KEY,JSON.stringify({
        version:APP_VERSION,data:this.data,savedAt:Date.now()
    }));
},

initGame(mode){
    this.data.mode=mode;this.data.history=[];this.data.tempScores={};
    this.data.players=mode==='belote'
        ?[{id:1,name:'NOUS',color:COLORS[0],total:0},
          {id:2,name:'EUX',color:COLORS[1],total:0}]
        :Array.from({length:4},(_,i)=>({id:i+1,name:'JOUEUR '+(i+1),color:COLORS[i],total:0}));
    this.data.dealerId=this.data.players[0].id;
    this.save();this.showGame();
},

showGame(){
    setup.classList.add('hidden');
    game.classList.remove('hidden');
    dock.classList.remove('hidden');
    this.render();
},

render(){
    grid.innerHTML='';
    this.data.players.forEach(p=>{
        const t=this.data.tempScores[p.id]||0;
        const el=document.createElement('div');
        el.className=`p-card ${p.id===this.data.dealerId?'is-dealer':''}
        ${p.id===this.activePlayerId?'is-active':''}`;
        el.innerHTML=`
        <div class="p-name">${p.name}</div>
        <div class="p-score">${p.total+t}</div>
        <div class="p-temp">${t||''}</div>`;
        el.onclick=()=>this.openSheet(p.id);
        grid.appendChild(el);
        setTimeout(()=>el.querySelector('.p-score').classList.add('bump'),0);
    });
},

openSheet(pid){
    this.activePlayerId=this.data.dealerId||pid;
    sheet.classList.add('active');
},

closeSheet(){sheet.classList.remove('active');this.render();},

typeNum(n){haptic();this.data.tempScores[this.activePlayerId]=(this.data.tempScores[this.activePlayerId]||0)*10+n;this.render()},
toggleNegative(){
    if(this.data.mode==='belote'){haptic("medium");return;}
    this.data.tempScores[this.activePlayerId]*=-1;this.render();
},
backspace(){this.data.tempScores[this.activePlayerId]=0;this.render()},

validateRound(){
    haptic("heavy");
    const round={};let sum=0;
    this.data.players.forEach(p=>{
        round[p.id]=this.data.tempScores[p.id]||0;
        p.total+=round[p.id];sum+=round[p.id];
    });
    if(this.data.mode==='belote'&&sum!==162){alert("Total incorrect");return;}
    this.data.history.push(round);
    this.data.tempScores={};
    this.save();this.render();
},

undo(){
    if(!this.data.history.length)return;
    haptic("medium");
    const r=this.data.history.pop();
    this.data.players.forEach(p=>p.total-=r[p.id]||0);
    this.save();this.render();
},

toggleDarkMode(){
    document.documentElement.classList.toggle('force-dark');
}
};

app.init();

// swipe down
let startY=null;
sheet.addEventListener('touchstart',e=>startY=e.touches[0].clientY,{passive:true});
sheet.addEventListener('touchmove',e=>{
    if(e.touches[0].clientY-startY>90)app.closeSheet();
},{passive:true});
</script>
</body>
</html>
